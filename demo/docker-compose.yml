version: "3.9"

services:
  reader:
    build:
      context: ..
      dockerfile: demo/Dockerfile
      args:
        GITHUB_TOKEN: ${GITHUB_TOKEN}  # must be set in .env or export
    container_name: detectmate_reader
    command: >
      detectmate start
      --settings demo/config/reader_settings.yaml
      --config demo/config/reader_config.yaml
    volumes:
      - ../demo/config:/app/demo/config
      - ../logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - detectmate_net

  parser:
    build:
      context: ..
      dockerfile: demo/Dockerfile
      args:
        GITHUB_TOKEN: ${GITHUB_TOKEN}
    container_name: detectmate_parser
    command: >
      detectmate start
      --settings demo/config/parser_settings.yaml
      --config demo/config/parser_config.yaml
    volumes:
      - ../demo/config:/app/demo/config
      - ../logs:/app/logs
    depends_on:
      - reader
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - detectmate_net

  detector:
    build:
      context: ..
      dockerfile: demo/Dockerfile
      args:
        GITHUB_TOKEN: ${GITHUB_TOKEN}
    container_name: detectmate_detector
    command: >
      detectmate start
      --settings demo/config/detector_settings.yaml
      --config demo/config/detector_config.yaml
    volumes:
      - ../demo/config:/app/demo/config
      - ../logs:/app/logs
    depends_on:
      - parser
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - detectmate_net

networks:
  detectmate_net:
    driver: bridge
